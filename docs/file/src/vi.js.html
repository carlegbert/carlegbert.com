<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/vi.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/carlegbert/wwwterm" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/fileobject.js~DirFile.html">DirFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/fileobject.js~FileObject.html">FileObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/fileobject.js~TxtFile.html">TxtFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/shell-command.js~ShellCommand.html">ShellCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/shell-command.js~ShellCommandResult.html">ShellCommandResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/shell.js~Shell.html">Shell</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/vi.js~Vi.html">Vi</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getChar">getChar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-print">print</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-printInline">printInline</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/vi.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/* eslint-env jquery */
// TODO: reorganize functions in this file so that they are grouped together more logically
// TODO: consider creating new &apos;buffer&apos; class
// TODO: refactor this class so that UI/data are more clearly delineated

import { getChar } from &apos;./io&apos;;

  /*
   * object encapsulating data, functions, and HTML elements for Vi session.
   * Each Vi session is tied to one filepath and zero or one files. TODO: change that
   * @class
   */
export default class Vi {
  /**
   * @constructor
   * @param {Object} shellRef reference to parent Shell object
   * @param {string[]} filePath
   * @param {Object} file reference to TxtFile to write to (optional)
   */
  constructor(shellRef, filePath, file = null) {
    /**
     * @type {Shell}
     */
    this.shellRef = shellRef;
    /**
     * @type {string[]}
     */
    this.filePath = filePath;
    /**
     * @type {TxtFile}
     */
    this.file = file;
    /**
     * @type {string}
     */
    this.mode = &apos;normal&apos;;
    /**
     * @type {string}
     */
    this.heldNum = &apos;&apos;;
    /**
     * @type {string}
     */
    this.commandText = &apos;&apos;;
    /**
     * @type {number}
     */
    this.cursorX = 0;
    /**
     * @type {number}
     */
    this.cursorY = 0;
    /**
     * @type {string[]}
     */
    this.bufferText = this.file === null ? [&apos;&apos;] : this.file.contents;
    /**
     * @type {HTMLElement}
     */
    this.editorElement = $(&apos;#editor&apos;);
    /**
     * @type {HTMLElement}
     */
    this.bufferElement = $(&apos;#editor-buffer&apos;);
    /**
     * @type {HTMLElement}
     */
    this.editorConsoleElement = $(&apos;#editor-console&apos;);
    /**
     * @type {HTMLElement}
     */
    this.termElement = $(&apos;#terminal&apos;);

    this.startSession();
  }

  /**
   * prepare HTML elements for vi session
   */
  startSession() {
    this.renderBuffer();
    this.editorConsoleElement.html(&apos;&apos;);
    this.termElement.toggle();
    this.editorElement.toggle();
  }

  /**
   * shortcut function to get line from buffer
   * defaults to value of cursorY
   * @param {number} y Y coordinate to retrieve
   * @return {string} Line from buffer
   */
  getBufferLine(y = this.cursorY) {
    return this.bufferText[y];
  }

  /**
   * get HTML element at specific y index. defaults to this.cursorY
   * @param {number} y Y index, 0-indexed
   * @return {Object} &lt;ed-y&gt; HTML element
   */
  getLineElement(y = this.cursorY) {
    return $(`#editor-buffer ed-y:nth-child(${y + 1})`);
  }

  /**
   * end vi session
   * @param {boolean} force Don&apos;t require buffer to be saved if force is true
   */
  endSession(force) {
    if (force || (this.file &amp;&amp; (this.file.contents === this.bufferText))) {
      this.editorConsoleElement.html(&apos;&apos;);
      this.bufferElement.html(&apos;&apos;);
      this.editorElement.toggle();
      this.termElement.toggle();
      this.shellRef.killChildProcess();
    } else {
      this.errorMessage(&apos;E37: No write since last change (add ! to override)&apos;);
    }
  }

  /**
   * write error text to vi console
   * @param {string} errText
   */
  errorMessage(errText) {
    this.editorConsoleElement.html(errText);
  }

  /**
   * pass keystroke event to correct function depending on mode
   * @param {Object} event Keystroke event object
   */
  parseKeystroke(event) {
    if (this.mode === &apos;normal&apos;) this.normalKeystroke(event);
    else if (this.mode === &apos;insert&apos;) this.insertKeystroke(event);
    else if (this.mode === &apos;command&apos;) this.commandKeystroke(event);
  }

  /**
   * handle normal mode keystroke
   * @param {Object} event Keystroke event object
   */
  normalKeystroke(event) {
    if (event.which === 186 &amp;&amp; event.shiftKey) { // :
      this.mode = &apos;command&apos;;
      this.editorConsoleElement.html(&apos;:&apos;);
    } else if (event.which === 73) { // i
      if (event.shiftKey) this.cursorX = 0;
      else if (this.getBufferLine().length === 0) this.cursorX += 1;
      this.setInsertMode();
    } else if (event.which === 65) { // a
      if (event.shiftKey) this.cursorX = this.getBufferLine().length + 1;
      else this.cursorX += 1;
      this.setInsertMode();
    } else if (event.which === 79) { // o
      if (!event.shiftKey) this.cursorY += 1;
      this.bufferText.splice(this.cursorY, 0, &apos;&apos;);
      this.cursorX = 0;
      this.renderBuffer();
      this.setInsertMode();
    } else if (event.which === 52 &amp;&amp; event.shiftKey) { // $
      this.cursorX = this.getBufferLine().length;
    } else if (event.which === 48 &amp;&amp; !event.shiftKey) { // 0
      this.cursorX = 0;
    } else if (this.heldNum) {
      for (let i = 0; i &lt; parseInt(this.heldNum, 10); i += 1) {
        this.repeatableNormalKeystroke(event);
      }
    } else {
      this.repeatableNormalKeystroke(event);
    }
    this.drawCursor();

    const c = getChar(event);
    if (parseInt(c, 10) &amp;&amp; (c !== 0 || this.heldNum)) this.heldNum += c;
    else this.heldNum = &apos;&apos;;
  }

  /**
   * enter insert mode
   */
  setInsertMode() {
    this.mode = &apos;insert&apos;;
    this.editorConsoleElement.html(&apos;&lt;strong&gt;-- INSERT --&lt;/strong&gt;&apos;);
    if (this.getBufferLine().length === 0) {
      this.cursorX += 1;
    }
  }

  /**
   * repeatable normal-mode keystroke events
   * @param {Object} event Keystroke event object
   */
  repeatableNormalKeystroke(event) {
    if (event.which === 72) { // h
      this.cursorX -= 1;
    } else if (event.which === 76) { // l
      this.cursorX += 1;
    } else if (event.which === 74) { // j
      this.cursorY += 1;
    } else if (event.which === 75) { // k
      this.cursorY -= 1;
    } else if (event.which === 13) { // enter
      this.cursorY += 1;
      this.cursorX = 0;
    } else if (event.which === 88) { // x
      this.deleteChar(this.cursorX, this.cursorY);
    }
  }

  /**
   * handle insert mode keystroke
   * @param {Object} event Keystroke event object
   */
  insertKeystroke(event) {
    if (event.which === 27) { // escape
      this.mode = &apos;normal&apos;;
      this.cursorX -= 1;
      this.drawCursor();
      this.editorConsoleElement.html(&apos;&apos;);
    } else if (event.which === 13) { // enter
      this.cursorX = 0;
      this.cursorY += 1;
      this.bufferText.splice(this.cursorY, 0, &apos;&apos;);
      this.renderBuffer();
    } else if (event.which === 8) { // backspace
      this.backspace(this.cursorX, this.cursorY);
    } else {
      this.writeChar(getChar(event), this.cursorX, this.cursorY);
      this.cursorX += 1;
      this.drawLine(this.getBufferLine(), this.currentLineElement);
      this.drawCursor();
    }
  }

  /** handle insert-mode backspace
   * @param {number} x X coord
   * @param {number} y Y coord
   */
  backspace(x, y) {
    const line = this.getBufferLine(y);
    if (x === 0 &amp;&amp; y !== 0) {
      this.cursorX = this.bufferText[y - 1].length;
      this.cursorY -= 1;
      this.bufferText[y - 1] += line;
      this.bufferText.splice(y, 1);
      this.renderBuffer();
    } else {
      this.deleteChar(x - 1, y);
      this.cursorX -= 1;
    }
    this.drawCursor();
  }

  /** delete buffer char at x/y
   * @param {number} x X coord
   * @param {number} y Y coord
   */
  deleteChar(x, y) {
    const line = this.getBufferLine(y);
    this.bufferText[y] = line.slice(0, x) + line.slice(x + 1);
    this.drawLine(this.getBufferLine(y), this.currentLineElement);
    // TODO: consider calling drawLine elsewhere
  }

  /**
   * write char to buffer at specified x,y coords
   * @param {string} str String to write
   * @param {number} x X coord
   * @param {number} y Y coord
   */
  writeChar(str, x, y) {
    const buffStr = this.bufferText[y];
    this.bufferText[y] = buffStr.slice(0, x) + str + buffStr.slice(x);
    this.drawLine(buffStr, this.currentLineElement);
  }

  /**
   * handle command mode keystroke
   * @param {Object} event Keystroke event object
   */
  commandKeystroke(event) {
    if (event.which === 27) { // escape
      this.mode = &apos;normal&apos;;
      this.commandText = &apos;&apos;;
      this.editorConsoleElement.html(&apos;&apos;);
    } else if (event.which === 13) { // enter
      this.executeCommand();
    } else if (event.which === 8) { // backspace
      this.commandText = this.commandText.slice(0, -1);
      this.editorConsoleElement.html(`:${this.commandText}`);
    } else {
      const c = getChar(event);
      this.commandText += c;
      this.editorConsoleElement.append(c);
    }
  }

  /**
   * execute command mode statement
   */
  executeCommand() {
    if (this.commandText === &apos;w&apos;) this.saveBuffer();
    else if (this.commandText === &apos;q&apos;) this.endSession(false);
    else if (this.commandText === &apos;q!&apos;) this.endSession(true);
    else if (this.commandText === &apos;wq&apos;) {
      const saveResult = this.saveBuffer();
      if (saveResult) this.endSession(false);
    } else this.errorMessage(`E492: Not an editor command: ${this.commandText}`);
    this.commandText = &apos;&apos;;
    this.mode = &apos;normal&apos;;
  }

  /**
   * reset cursor indices to within bounds of buffer text;
   * redraw cursor. allow cursor to be after last char in line if in insert mode.
   */
  drawCursor() {
    const yMax = this.bufferText.length - 1;
    if (this.cursorY &lt; 0) this.cursorY = 0;
    if (this.cursorY &gt; yMax) this.cursorY = yMax;
    let xMax = this.getBufferLine().length - 1;
    if (this.mode === &apos;insert&apos; || this.getBufferLine().length === 0) xMax += 1; // allow cursor at EOL in insert mode or if line is empty
    if (this.cursorX &lt; 0) this.cursorX = 0;
    if (this.cursorX &gt; xMax) this.cursorX = xMax;
    if (this.cursorElement) this.cursorElement.removeClass(&apos;cursor&apos;);
    const jqStr = `#editor-buffer ed-y:nth-child(${this.cursorY + 1}) ed-x:nth-child(${this.cursorX + 1})`;
    this.cursorElement = $(jqStr);
    this.cursorElement.addClass(&apos;cursor&apos;);
  }

  /**
   * save buffer text to FileObject. attempt to write new file if none exists.
   * @return {boolean} returns true on success, false on failure
   */
  saveBuffer() {
    if (!this.file) this.writeNewFile();
    if (!this.file) return false;
    this.file.contents = this.bufferText;
    this.editorConsoleElement.html(`${this.file.fullPath}: File written`);
    return true;
  }

  /**
   * create new FileObject and assign it to Vi session
   */
  writeNewFile() {
    const newFileResult = this.shellRef.newFile(this.filePath, &apos;txt&apos;);
    if (!newFileResult.data) return false;
    this.file = newFileResult.data;
    return true;
  }

  /**
   * rewrite string so that every character is enveloped by an &lt;ed-x&gt; tag,
   * so that we can traverse it with nth-child selector. space chars will
   * be replaced with &apos;&amp;nbsp;&apos;
   * @param {string} str Original string
   * @return {string} New string
   */
  static edxString(str) {
    let fStr = &apos;&apos;;
    for (let i = 0; i &lt; str.length; i += 1) {
      const c = str[i] === &apos; &apos; ? &apos;&amp;nbsp;&apos; : str[i];
      fStr += `&lt;ed-x&gt;${c}&lt;/ed-x&gt;`;
    }
    fStr += &apos;&lt;ed-x&gt;&amp;nbsp;&lt;/ed-x&gt;&apos;;
    return fStr;
  }

  /**
   * draw single line in editor buffer.
   * appended to end if no line element is provided.
   * @param {string} str String to print
   * @param {Object} lineElement HTML line element to print to (optional, appended at end of buffer
   * if not provided)
   */
  drawLine(str, lineElement) {
    const fStr = Vi.edxString(str);
    if (lineElement) $(`#editor-buffer ed-y:nth-child(${this.cursorY + 1})`).html(fStr);
    else this.bufferElement.append(`&lt;ed-y&gt;${fStr}&lt;/ed-y&gt;`);
  }

  /**
   * render entire contents of buffer
   */
  renderBuffer() {
    this.bufferElement.html(&apos;&apos;);
    this.bufferText.forEach(str =&gt; this.drawLine(str));
    this.currentLineElement = this.getLineElement();
    this.drawCursor();
  }

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
